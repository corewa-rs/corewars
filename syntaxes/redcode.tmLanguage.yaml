$schema: 'https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json'
name: Redcode
scopeName: source.redcode
patterns:
  - include: '#keywords'
  - include: '#builtins'
  - include: '#directives'
  - include: '#comment'
  - include: '#expression'
  - include: '#label'
  - include: '#number'
repository:
  keywords:
    patterns:
      - name: keyword.operator.control.opcode.88.redcode
        match: (?i)\b(DAT|MOV|ADD|SUB|JMP|JMZ|JMN|DJN|SLT|CMP|SPL)\b
      - name: keyword.operator.control.opcode.94.redcode
        match: (?i)\b(MUL|DIV|MOD|SEQ|SNE|NOP)\b
      - name: keyword.operator.control.opcode.p-space.redcode
        match: (?i)\b(LDP|STP)\b
      - name: keyword.operator.control.psuedo-opcode.88.redcode
        match: (?i)\b(EQU|END|FOR|ROF)\b
      - name: keyword.operator.control.psuedo-opcode.94.redcode
        match: (?i)\b(ORG)\b
      - name: keyword.operator.control.psuedo-opcode.p-space.redcode
        match: (?i)\b(PIN)\b
  builtins:
    patterns:
      - name: constant.language.88.redcode
        match: \b(CORESIZE|MAXPROCESSES|MAXCYCLES|MAXLENGTH)\b
      - name: constant.language.94.redcode
        match: \b(MINDISTANCE|ROUNDS|CURLINE|VERSION|WARRIORS)\b
      - name: constant.language.p-space.redcode
        match: \b(PSPACESIZE)\b
  comment:
    begin: ';'
    # TODO include line continuations? Parser doesn't support yet
    end: '$'
    patterns:
      - include: '#builtins'
      - include: '#number'
      - include: '#directives'
      # Hmm, for some reason 'builtins' and 'number' don't work but 'directives' does
      - match: '.*'
    name: comment.line.semicolon.redcode
  directives:
    patterns:
      - name: keyword.operator.directive.main.redcode
        match: (?i)\b(redcode([^-]|$))\b
      - name: keyword.operator.directive.redcode
        match: (?i)\b(assert|author|break|name)\b
      - name: keyword.operator.directive.koth.main.redcode
        match: (?i)\b(redcode-[a-zA-Z0-9]+)\b
      - name: keyword.operator.directive.koth.redcode
        match: (?i)\b(help|kill|status|strategy|test|password|newpasswd|newredcode|url|version)\b
      - name: keyword.operator.directive.debug.redcode
        match: (?i)\b(debug[[:blank:]]+(off|static))\b
      - name: keyword.operator.directive.trace.redcode
        match: (?i)\b(trace[[:blank:]]+off)\b
  label:
    patterns:
      - name: variable.redcode
        match: '^\b([a-zA-Z_][a-zA-Z0-9_]*[:]?)\b'
  expression:
    patterns:
      - name: keyword.operator.address-mode.88.redcode
        match: '[#$@<]'
      - name: keyword.operator.address-mode.94.redcode
        match: '[>*{}]'
      - name: keyword.operator.modifier.redcode
        match: '(?i)\b(\.([ABFXI]|AB|BA))\b'
      - include: '#builtins'
  number:
    patterns:
      - name: constant.numeric.redcode
        match: \b\d+\b

